<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================ -->
    <!-- Refactoring: Rename player IDs to user IDs  -->
    <!-- ============================================ -->
    <!--
        This migration renames columns to clarify the semantic difference between:
        - User: permanent identity across all games (UserId)
        - Player: participation in a specific game (PlayerId - ephemeral, not persisted)

        The database stores UserIds, not PlayerIds.
        PlayerIds are generated on-the-fly when reconstructing Games from DB.
    -->

    <changeSet id="20251123091800-001-rename-games-player-columns" author="gchess">
        <comment>Rename games table columns from player_id to user_id for clarity</comment>

        <!-- Drop existing foreign keys before renaming -->
        <dropForeignKeyConstraint
            baseTableName="games"
            constraintName="fk_games_white_player"/>

        <dropForeignKeyConstraint
            baseTableName="games"
            constraintName="fk_games_black_player"/>

        <!-- Rename columns -->
        <renameColumn
            tableName="games"
            oldColumnName="white_player_id"
            newColumnName="white_user_id"
            columnDataType="VARCHAR(26)"/>

        <renameColumn
            tableName="games"
            oldColumnName="black_player_id"
            newColumnName="black_user_id"
            columnDataType="VARCHAR(26)"/>

        <!-- Recreate foreign keys with new column names -->
        <addForeignKeyConstraint
            baseTableName="games"
            baseColumnNames="white_user_id"
            constraintName="fk_games_white_user"
            referencedTableName="users"
            referencedColumnNames="id"/>

        <addForeignKeyConstraint
            baseTableName="games"
            baseColumnNames="black_user_id"
            constraintName="fk_games_black_user"
            referencedTableName="users"
            referencedColumnNames="id"/>

        <!-- Drop existing indexes -->
        <dropIndex tableName="games" indexName="idx_games_white_player"/>
        <dropIndex tableName="games" indexName="idx_games_black_player"/>

        <!-- Recreate indexes with new column names -->
        <createIndex tableName="games" indexName="idx_games_white_user">
            <column name="white_user_id"/>
        </createIndex>

        <createIndex tableName="games" indexName="idx_games_black_user">
            <column name="black_user_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="20251123091800-002-rename-matches-player-columns" author="gchess">
        <comment>Rename matches table columns from player_id to user_id for clarity</comment>

        <!-- Drop existing foreign keys before renaming -->
        <dropForeignKeyConstraint
            baseTableName="matches"
            constraintName="fk_matches_white_player"/>

        <dropForeignKeyConstraint
            baseTableName="matches"
            constraintName="fk_matches_black_player"/>

        <!-- Rename columns -->
        <renameColumn
            tableName="matches"
            oldColumnName="white_player_id"
            newColumnName="white_user_id"
            columnDataType="VARCHAR(26)"/>

        <renameColumn
            tableName="matches"
            oldColumnName="black_player_id"
            newColumnName="black_user_id"
            columnDataType="VARCHAR(26)"/>

        <!-- Recreate foreign keys with new column names -->
        <addForeignKeyConstraint
            baseTableName="matches"
            baseColumnNames="white_user_id"
            constraintName="fk_matches_white_user"
            referencedTableName="users"
            referencedColumnNames="id"/>

        <addForeignKeyConstraint
            baseTableName="matches"
            baseColumnNames="black_user_id"
            constraintName="fk_matches_black_user"
            referencedTableName="users"
            referencedColumnNames="id"/>

        <!-- Drop existing indexes -->
        <dropIndex tableName="matches" indexName="idx_matches_white_player"/>
        <dropIndex tableName="matches" indexName="idx_matches_black_player"/>

        <!-- Recreate indexes with new column names -->
        <createIndex tableName="matches" indexName="idx_matches_white_user">
            <column name="white_user_id"/>
        </createIndex>

        <createIndex tableName="matches" indexName="idx_matches_black_user">
            <column name="black_user_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
