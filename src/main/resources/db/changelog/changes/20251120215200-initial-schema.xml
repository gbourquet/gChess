<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================ -->
    <!-- Table: users                                 -->
    <!-- ============================================ -->
    <changeSet id="20251120215200-001-create-users-table" author="gchess">
        <comment>Create users table for user authentication and profiles</comment>

        <createTable tableName="users">
            <column name="id" type="VARCHAR(26)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password_hash" type="VARCHAR(60)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Case-insensitive index for username lookups -->
        <sql>
            CREATE INDEX idx_users_username_lower ON users(LOWER(username));
        </sql>

        <!-- Case-insensitive index for email lookups -->
        <sql>
            CREATE INDEX idx_users_email_lower ON users(LOWER(email));
        </sql>
    </changeSet>

    <!-- ============================================ -->
    <!-- Table: games                                 -->
    <!-- ============================================ -->
    <changeSet id="20251120215200-002-create-games-table" author="gchess">
        <comment>Create games table for chess games persistence</comment>

        <createTable tableName="games">
            <column name="id" type="VARCHAR(26)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <!-- User IDs: Permanent user identity (UserId) -->
            <column name="white_user_id" type="VARCHAR(26)">
                <constraints nullable="false"/>
            </column>
            <column name="black_user_id" type="VARCHAR(26)">
                <constraints nullable="false"/>
            </column>
            <!-- Player IDs: Unique participation identity per game (PlayerId) -->
            <column name="white_player_id" type="VARCHAR(26)">
                <constraints nullable="false"/>
            </column>
            <column name="black_player_id" type="VARCHAR(26)">
                <constraints nullable="false"/>
            </column>
            <!-- Game state -->
            <column name="board_fen" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="current_side" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign keys to users -->
        <addForeignKeyConstraint
            baseTableName="games"
            baseColumnNames="white_user_id"
            constraintName="fk_games_white_user"
            referencedTableName="users"
            referencedColumnNames="id"/>

        <addForeignKeyConstraint
            baseTableName="games"
            baseColumnNames="black_user_id"
            constraintName="fk_games_black_user"
            referencedTableName="users"
            referencedColumnNames="id"/>

        <!-- Indexes for user lookups -->
        <createIndex tableName="games" indexName="idx_games_white_user">
            <column name="white_user_id"/>
        </createIndex>

        <createIndex tableName="games" indexName="idx_games_black_user">
            <column name="black_user_id"/>
        </createIndex>

        <!-- Indexes for player lookups (WebSocket connection management) -->
        <createIndex tableName="games" indexName="idx_games_white_player_id">
            <column name="white_player_id"/>
        </createIndex>

        <createIndex tableName="games" indexName="idx_games_black_player_id">
            <column name="black_player_id"/>
        </createIndex>

        <!-- Index for game status filtering -->
        <createIndex tableName="games" indexName="idx_games_status">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- ============================================ -->
    <!-- Table: game_moves                            -->
    <!-- ============================================ -->
    <changeSet id="20251120215200-003-create-game-moves-table" author="gchess">
        <comment>Create game_moves table for move history tracking</comment>

        <createTable tableName="game_moves">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="game_id" type="VARCHAR(26)">
                <constraints nullable="false"/>
            </column>
            <column name="move_number" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="from_square" type="VARCHAR(2)">
                <constraints nullable="false"/>
            </column>
            <column name="to_square" type="VARCHAR(2)">
                <constraints nullable="false"/>
            </column>
            <column name="promotion" type="VARCHAR(10)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign key with CASCADE delete (moves deleted when game is deleted) -->
        <addForeignKeyConstraint
            baseTableName="game_moves"
            baseColumnNames="game_id"
            constraintName="fk_game_moves_game"
            referencedTableName="games"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Unique constraint on (game_id, move_number) -->
        <addUniqueConstraint
            tableName="game_moves"
            columnNames="game_id, move_number"
            constraintName="uk_game_moves_game_number"/>

        <!-- Index for move history retrieval -->
        <createIndex tableName="game_moves" indexName="idx_game_moves_game">
            <column name="game_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
